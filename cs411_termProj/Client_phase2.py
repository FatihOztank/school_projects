from ecpy.curves import Curve, Point
from Crypto.Hash import SHA3_256,HMAC,SHA256
from Crypto.Cipher import AES
import requests
from random import randint
from helpers import sign_msg,decrypt,decryptAndAuth_p2
API_URL = 'http://cryptlygos.pythonanywhere.com'

stuID = 25060

# HERE CREATE A LONG TERM KEY
E = Curve.get_curve('secp256k1')
n = E.order
p = E.field
P = E.generator
a = E.a
b = E.b
# long term key, same rand key i used for phase 1
priv_key = 25599029407980303215847102866217791268869757416928311560876676855629646051246
# priv key was a rand num between 0 and n-1,
QCli_long = priv_key * P  # long term public key, same as phase 1

QSer_long = Point(0xc1bc6c9063b6985fe4b93be9b8f9d9149c353ae83c34a434ac91c85f61ddd1e9,
                  0x931bd623cf52ee6009ed3f50f6b4f92c564431306d284be7e97af8e443e69a8c, E)


# register the long term keys again for phase2. Uncomment for registiration
"""
h,s = sign_msg(stuID,priv_key,E)
####Register Long Term Key
mes = {'ID':25060, 'H': h, 'S': s, 'LKEY.X': QCli_long.x, 'LKEY.Y': QCli_long.y}
response = requests.put('{}/{}'.format(API_URL, "RegLongRqst"), json = mes)
print(response.json())
code = input()

mes = {'ID':25060, 'CODE': code}
response = requests.put('{}/{}'.format(API_URL, "RegLong"), json = mes)
print(response.json())
"""


#  i generated 10 ephemeral priv keys beforehand and wrote the them here
eph_keys = [21768620007863989446088075639353568278812706993646186070154571999203860051223,
            41185374378207400100785583932441602486854225013567358880799808652977100084396,
            87494731926563998071657857727979521970205471447164796293328644201742765192738,
            49111810016928988503853044056456091176377872386865676138241851933114631006514,
            88306641089073786732377549894985069536515415992946287849782341580687875194294,
            17495149125087945549402595177384356197274080091998981014903580078961021116970,
            42805756947087106240336604293181044788755569281357784977987534419765989621900,
            96018012841474365187383140758172727046922629593067562042195703732621275665145,
            6079533506434800128419135874202667833230156254438094118478933767242875603452,
            13774133086399079416568214636520634361150932982493867771771246556946378726775
            ]
# ephemeral keys are registered here, uncomment for eph. registiration

for i in range(10):
    eph_priv_key = eph_keys[i]  # it was random number between 1 and n-1
    ekey = eph_priv_key * P
    #print(eph_priv_key)  # i printed the priv keys in the beggining to record them.

    s, h = sign_msg(str(ekey.x) + str(ekey.y),priv_key,E)  # msg signed here
    # send ephemeral key
    mes = {'ID': stuID, 'KEYID': i, 'QAI.X': ekey.x, 'QAI.Y': ekey.y, 'Si': s, 'Hi': h}
    response = requests.put('{}/{}'.format(API_URL, "SendKey"), json=mes)
    print(response.json())






h,s = sign_msg(stuID,priv_key,E)
#Receiving Messages
for i in range(5):
    mes = {'ID_A': stuID, 'S': s, 'H': h}
    response = requests.get('{}/{}'.format(API_URL, "ReqMsg"), json = mes)
    print(response.json())



# array of messages i received from the server, i copied those messages from print statement and saved them below.
p2_msg = [
{'IDB': 25127, 'KEYID': 0, 'MSG': 109371545707755215539759607662154033129422355636919261631525570228125105632050070482461189676981754391265654971835092411022159, 'QBJ.X': 71247437917307075278226029447898454958088831495471389050962547995388441955407, 'QBJ.Y': 100048310595697034298562078667859903554154423680131334855274924712400729172788}

{'IDB': 18007, 'KEYID': '0', 'MSG': 50607129645214777674510380068774798850330297733373462270345604542664973009704619738151506105552588846245837836897683583243063268424356253541023101549050427594316028336174368375000411574639415755367069, 'QBJ.X': 29809038207395552533342107814280105677335920300687211449552578351249457089265, 'QBJ.Y': 37162326059429784322837275165878696592073159102911588209766660603350200809460},
{'IDB': 18007, 'KEYID': '1', 'MSG': 4099033155909572583424309340974679189048192127976044077430769514419011351065647654973324673076534641296709272629673576832396914157776351819491953145124489433820631585906876945605937649045432887456037, 'QBJ.X': 38176457741737414886254713389939675870157017728063758839187035652978539596418, 'QBJ.Y': 13620214169312049780478273908533622793208941392196580135260975497148262021030},
{'IDB': 18007, 'KEYID': '2', 'MSG': 57963891165702273597700054217140363538470362768106856451697374810181052395963132136137712181948556441180322625933650795729515009800547239879158151198167515908059826917324540246976433704532980563970024, 'QBJ.X': 92616735683818440862465084795730657251038165718965944868476897386372920424185, 'QBJ.Y': 72413296572281086660868417666969713579039834663677466411019372004359180842959},
{'IDB': 18007, 'KEYID': '3', 'MSG': 10107089136456035285705008150071309653092414118036809772249767732427048305454953832422785698053079301952063987949305013481743277798112095174737240134386332770742691548572475952687361706006959242424337, 'QBJ.X': 74355609372322011412117941181272440676850040122230496837853188468944397723817, 'QBJ.Y': 100826559707391322969203658133754843072486949635355597479896612255099146060911},
{'IDB': 18007, 'KEYID': '4', 'MSG': 52748924545077515842066718713001256526814167047982884464043299381872637159870984253254765889768203211073591238235732894773195958843674887321995529100062871525412423143855662082325706679617966774433811, 'QBJ.X': 20413765870498279745352923074399659918082558297327677855412869046323286431422, 'QBJ.Y': 63929418819972176986459835984347552756866704278341004029745733156548670911451}
]




for each in p2_msg:
    # decrypt messages
    x = decryptAndAuth_p2(each,E,eph_keys)
    print(x)

    # send decrypted messages to server
    mes = {'ID_A': stuID, 'DECMSG': x}
    response = requests.put('{}/{}'.format(API_URL, "Checker"), json=mes)
    print(response.json())





